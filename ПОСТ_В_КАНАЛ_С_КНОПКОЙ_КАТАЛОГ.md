# Пост в канал с кнопкой «Каталог» — пошагово

Чтобы из канала **@travelplusbiz** по **одному нажатию** открывался мини-апп (а не бот), бот должен опубликовать в канал сообщение с кнопкой типа Web App. Ниже — что куда добавить и в каком порядке делать.

---

## Что уже есть в проекте

- Бот **@travelplus_shop_bot** (токен в `TELEGRAM_BOT_TOKEN`).
- Канал **@travelplusbiz**.
- API **api/send.ts** — отправка заявок в Telegram.
- Новый API **api/post-channel-message.ts** — отправка одного поста в канал с кнопкой «Каталог» (Web App).

Ты только настраиваешь переменные и один раз вызываешь ссылку.

---

## Шаг 1. Переменные в Vercel

1. Зайди на [vercel.com](https://vercel.com) → свой проект **travelplus-miniapp**.
2. Открой **Settings** → **Environment Variables**.
3. Убедись, что уже есть:
   - **TELEGRAM_BOT_TOKEN** — токен бота @travelplus_shop_bot.
   - **TELEGRAM_CHAT_ID** — куда приходят заявки (чат/группа).
4. Добавь **три новые** переменные (для каждого выбери окружение **Production**, при необходимости и Preview):

   | Name | Value | Зачем |
   |------|--------|--------|
   | **TELEGRAM_CHANNEL_ID** | `@travelplusbiz` | Куда бот постит сообщение с кнопкой. |
   | **APP_URL** | `https://travelplus-miniapp.vercel.app` | URL мини-аппа (тот же, что в Menu Button бота). Если у тебя другой домен — подставь его. |
   | **POST_CHANNEL_SECRET** | Придумай длинный секрет, например `mойСекретныйКлюч123` | Защита: только тот, кто знает этот ключ, сможет отправить пост в канал. |

5. Сохрани переменные (**Save**).

---

## Шаг 2. Бот — админ канала с правом постить

1. Открой канал **@travelplusbiz** в Telegram.
2. Зайди в **Управление каналом** (название канала сверху → Управление каналом).
3. **Администраторы** → **Добавить администратора**.
4. Найди бота **@travelplus_shop_bot** и добавь его.
5. У бота включи право **Публикация сообщений** (или «Post messages»). Остальные права можно не давать.
6. Сохрани.

Без этого бот не сможет отправить сообщение в канал.

---

## Шаг 3. Залить код и задеплоить

Код API и правки в `vercel.json` уже в проекте. Нужно только залить их на Vercel.

1. В терминале, в **корне** проекта (папка `travelplus-miniapp`), выполни:
   ```bash
   git add api/post-channel-message.ts vercel.json ПОСТ_В_КАНАЛ_С_КНОПКОЙ_КАТАЛОГ.md
   git commit -m "API: пост в канал с кнопкой Каталог (Web App)"
   git push
   ```
2. Дождись окончания деплоя на Vercel (статус **Ready**).

---

## Шаг 4. Один раз вызвать API (отправить пост в канал)

После деплоя нужно **один раз** вызвать новый API с твоим секретом. Тогда бот отправит в канал одно сообщение с кнопкой «Каталог».

1. Открой в браузере ссылку (подставь свой домен и свой секрет из шага 1):
   ```
   https://travelplus-miniapp.vercel.app/api/post-channel-message?key=ТВОЙ_POST_CHANNEL_SECRET
   ```
   Пример: если секрет был `mойСекретныйКлюч123`, то:
   ```
   https://travelplus-miniapp.vercel.app/api/post-channel-message?key=mойСекретныйКлюч123
   ```
2. Должен вернуться ответ вроде:  
   `{"ok":true,"message":"Сообщение с кнопкой «Каталог» отправлено в канал..."}`  
   Если видишь ошибку — см. раздел «Ошибки» ниже.
3. Зайди в канал **@travelplusbiz** — там должно появиться **новое сообщение от бота** с текстом и кнопкой **«Каталог»**.

---

## Шаг 5. Закрепить пост в канале (по желанию)

1. В канале **@travelplusbiz** найди только что отправленное сообщение от бота с кнопкой «Каталог».
2. Долгое нажатие на это сообщение → **Закрепить** (Pin).
3. Пост будет всегда сверху, кнопка «Каталог» — всегда на виду.

---

## Проверка

1. Открой канал **@travelplusbiz** (можно с другого аккаунта).
2. Нажми на кнопку **«Каталог»** под сообщением от бота.
3. Должно сразу открыться окно «Открывая это мини-приложение…» → **Запустить** → откроется каталог (мини-апп). Без перехода в чат с ботом.

---

## Ошибки

| Ответ API | Что сделать |
|-----------|-------------|
| `Missing TELEGRAM_CHANNEL_ID` | В Vercel добавь переменную **TELEGRAM_CHANNEL_ID** = `@travelplusbiz`, сохрани и сделай **Redeploy**. |
| `Missing POST_CHANNEL_SECRET` | Добавь **POST_CHANNEL_SECRET** в Vercel, сохрани, Redeploy. В ссылке используй тот же секрет: `?key=...`. |
| `Invalid key` | В ссылке после `?key=` должен быть **ровно** тот же текст, что в переменной **POST_CHANNEL_SECRET** (без пробелов). |
| `Chat not found` / `Bot was blocked` | Бот должен быть добавлен в канал как администратор с правом «Публикация сообщений». Проверь шаг 2. |
| `TELEGRAM_BOT_TOKEN` / `TELEGRAM_CHAT_ID` | Они уже используются в api/send; если заявки приходят — не трогай. Для поста в канал нужны ещё **TELEGRAM_CHANNEL_ID**, **APP_URL**, **POST_CHANNEL_SECRET**. |

---

## Кратко: что куда

| Шаг | Где | Что сделать |
|-----|-----|-------------|
| 1 | Vercel → Settings → Environment Variables | Добавить **TELEGRAM_CHANNEL_ID** = `@travelplusbiz`, **APP_URL** = `https://travelplus-miniapp.vercel.app`, **POST_CHANNEL_SECRET** = свой секрет. |
| 2 | Канал @travelplusbiz → Управление каналом → Администраторы | Добавить бота @travelplus_shop_bot, включить «Публикация сообщений». |
| 3 | Терминал в корне проекта | `git add ... && git commit ... && git push`, дождаться деплоя. |
| 4 | Браузер | Один раз открыть `https://travelplus-miniapp.vercel.app/api/post-channel-message?key=ТВОЙ_SECRET`. |
| 5 | Канал @travelplusbiz | Закрепить пост с кнопкой «Каталог». |

После этого в канале будет пост с кнопкой, по нажатию — сразу мини-апп.
